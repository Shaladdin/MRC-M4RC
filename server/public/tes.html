<!DOCTYPE html>
<html>

<head>
    <TITLE>Chat Client</TITLE>
</head>

<body>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script>
        var webSocket;
        var firstTime = true;

        function connectWsChat() {
            try {
                window.WebSocket = window.WebSocket || window.MozWebSocket;
                var host = 'wss://example.com:8089/';
                webSocket = new WebSocket(host);
                webSocket.onopen = function () {
                    var chatUser = $('#chatUser').val();
                    webSocket.send('<p>' + chatUser + ' has entered the chat room');
                    $('#chatButton').text('Disconnect');
                }
                webSocket.onmessage = function (msg) {
                    logWsChatMessage('<p class="message">' + msg.data + '</p>');
                }
                webSocket.onclose = function () {
                    var chatUser = $('#chatUser').val();
                    logWsChatMessage('<p>' + chatUser + ' has left the chat room</p>');
                    // $( '#chatButton' ).text( 'Connect' );
                }
            }
            catch (exception) {
                logWsChatMessage('<p>Error ' + exception + '.</p>');
            }
        }

        function isConnectedWsChat() {
            if (webSocket && webSocket.readyState == 1) {
                $('#chatButton').text('Disconnect');
                return 1;
            }
        }

        function playSound() {
            var audio = new Audio('notify.mp3');
            audio.play();
        }


        function sendWsChat() {
            var chatLog = $('#chatLog');
            if (isConnectedWsChat()) {
                var chatUser = $('#chatUser').val();
                var chatText = $('#chatText').val();
                if (chatUser == '' || chatText == '') {
                    return;
                }
                try {
                    chatLog.scrollTop(chatLog.prop('scrollHeight'));
                    webSocket.send(chatUser + ': ' + chatText);
                    //logWsChatMessage( '<p class="event">Sent: ' + chatText + '</p>' )
                } catch (exception) {
                    logWsChatMessage('<p class="warning"> Error: ' + exception + '</p>');
                }
                $('#chatText').val('');
            }
        }

        function logWsChatMessage(msg) {
            var chatLog = $('#chatLog');
            var sTop = Math.round(chatLog.prop('scrollTop'));
            var sHeight = chatLog.prop('scrollHeight');
            var cHeight = chatLog.prop('clientHeight');

            chatLog.append('<p>' + msg + '</p>');

            if (firstTime) {
                chatLog.scrollTop(chatLog.prop('scrollHeight'));
                firstTime = false;
            }
            else if (sTop + cHeight == sHeight) {
                chatLog.scrollTop(chatLog.prop('scrollHeight'));
            }
            playSound();
        }

        $(document).ready(function () {

            if (!('WebSocket' in window)) {
                $('#chatInput').fadeOut('fast');
                $('<p>Oh no, you need a browser that supports WebSockets.</p>')
                    .appendTo('#chatContainer');
            } else {
                connectWsChat();
            }

            $('#chatText').keypress(function (event) {
                if (event.keyCode == '13') {
                    sendWsChat();
                }
            });

            $('#startButton').click(function () {
                window.open('chat.pl', '_self');
            });

            $('#saveButton').click(function () {
                window.open('chat1.pl', '_self');
            });


            $('#chatButton').click(function () {
                if (webSocket && webSocket.readyState == 1) {
                    var chatUser = $('#chatUser').val();
                    webSocket.send('<p>' + chatUser + ' has left the chat room.</p>');
                    webSocket.close();
                    $(this).text('Connect');
                } else {
                    //webSocket.open();
                    connectWsChat();
                    $(this).text('Disconnect');
                }
            });

            $(window).on("unload", function (e) {
                if (webSocket && webSocket.readyState == 1) {
                    var chatUser = $('#chatUser').val();
                    webSocket.send('<p>' + chatUser + ' has left the chat room.</p>');
                    webSocket.close();
                }
            });

        });
    </script>
    <div id="chatContainer">
        <div id="chatLog">
        </div>
        <div id="chatInput">
            <p>Name: <input id='chatUser' type="text" size=40 />
                <br>Text: <input id="chatText" type="text" size=40 />
                <br><button id="chatButton">Chat not yet set up</button>
            </p>
        </div>
    </div>
</body>

</html>